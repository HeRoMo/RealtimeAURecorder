<html>
<head>
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<body>
  <h1>グラフ<h1>
  <div>
    <select id="name">
      <option>選択して下さい</option>
      <? for(var i = 0; i < settings.length; i++) { ?>
        <option value="<?=settings[i].name?>"><?=settings[i].name?></option>
      <? } ?>
    </select>

    <select id="year">
      <? for(var i = 0; i < years.length; i++) { ?>
        <option value="<?=years[i]?>"><?=years[i]?></option>
      <? } ?>
    </select>
    <select id="yearMonth"></select>
  </div>
  <div id="curve_chart" style="width: 900px; height: 600px"></div>
  <script type="text/javascript">

    function drawChart() {
      var data = new google.visualization.DataTable();
      data.addColumn('datetime', '日時');
      data.addColumn('number', 'Realtime Active Users');
      data.addRows(auData);

      var options = {
        title: 'アクティブユーザ',
        legend: { position: 'bottom' },
        width: '900',
        height: '600',
        hAxis: {
          format: 'HH:mm',
          gridlines: {count: 15}
        },
        timeZone: 9
      };

      var format = new google.visualization.DateFormat({pattern: "yyyy-MM-dd HH:mm"});
      format.format(data, 0);
      var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));
      chart.draw(data, options);
    }

    function dispChart(data){
      auData = data.map(row => { return [new Date(row[0]), row[1]]})
      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);
    }

    var auData = JSON.parse(<?= data ?>);
    if(auData.length > 0){
      dispChart(auData);
    }

    function insertOptions(selector, list){
      var yearSelect = document.querySelector(selector)
      var yearOptions = '';
      for (var i = 0; i < list.length; i++){
        var option = (i == 0) ?
          '<option value="'+list[i].value+'" selected>'+list[i].name+'</option>' :
          '<option value="'+list[i].value+'">'+list[i].name+'</option>';
        yearOptions = yearOptions + option;
      }
      yearSelect.innerHTML = yearOptions;
    }

    document.querySelector("select#name").addEventListener('change',function(e){
      function onSuccess(years){
        insertOptions('select#year', years)
      }
      function onFailure(error){console.error(error)}

      var name = e.target.value;
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .getYears(name)
    });

    document.querySelector('select#year').addEventListener('change',function(e){
      function onSuccess(yearMonths){
        insertOptions('select#yearMonth', yearMonths)
      }
      function onFailure(error){console.error(error)}

      var name = document.querySelector("select#name").value;
      var year = e.target.value;
      google.script.run
        .withSuccessHandler(onSuccess)
        .withFailureHandler(onFailure)
        .getYearMonths(name, year)
    });
  </script>
</body>
</html>
